#!/usr/bin/env bash
# Flatpak management wrapper with fzf integration
#
set -euo pipefail

#Check for dependencies
dependencies=(flatpak fzf)
for dependency in "${dependencies[@]}"; do
  if ! command -v "$dependency" > /dev/null; then
    echo "ERROR: $dependency not found"
    exit 1
  fi
done

#Global variables
readonly QUERY="${2:-}"

show_help() {
    cat << EOF
Usage: $(basename "$0") [OPTION] [QUERY]
Flatpak management wrapper with fzf integration

OPTIONS:
    -s  Search for packages
    -i  Install package
    -l  List installed packages
    -r  Remove package
    -u  Update all packages
    -h  Show this help

EXAMPLES:
    $(basename "$0") -s firefox
    $(basename "$0") -i
EOF
}

flatpak_picker(){
  local application query
  if [[ "$#" -eq 1 ]]; then
    query="$1"
    application=$(fzf -q "$query" --delimiter='\t' --with-nth=1,2)
  elif [[ "$#" -eq 0 ]]; then
    application=$(fzf --delimiter='\t' --with-nth=1,2)
  else
    echo "ERROR: flatpak_picker can't have more than 1 argument"
  fi
  app_id=$(echo "$application" | awk -F '\t' '{print $3}')
  echo "$app_id"
}

flatpak_list(){
  if [[ -n "$QUERY" ]]; then
    flatpak list --columns=name,description,application | flatpak_picker "$QUERY"
  else 
    flatpak list --columns=name,description,application | flatpak_picker 
  fi
}

copy_id(){
  command -v wl-copy > /dev/null \
    && wl-copy \
    || echo 'WARNING: wl-copy not found' \
    && cat
}

while getopts "silru" flag; do
  case "$flag" in
    's')
      if [[ -n "$QUERY" ]]; then
        flatpak search "$QUERY" | flatpak_picker | copy_id 
      else
        echo "ERROR: No query was given" ; exit 1
      fi
      ;; 
    'i')
      if [[ -n "$QUERY" ]]; then
        app_id=$(flatpak search "$QUERY" | flatpak_picker)
        [[ -n "$app_id" ]] && flatpak install "$app_id"
      else
        echo "ERROR: No query was given" ; exit 1
      fi
      ;;
    'l')
      flatpak_list | copy_id
      ;;
    'r')
      app_id=$(flatpak_list)
      [[ -n "$app_id" ]] && flatpak remove --delete-data "$app_id"
      ;;
    'u')
      flatpak update
      ;;
    ?)
      show_help
      exit 1
  esac
done
