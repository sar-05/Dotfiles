return {
  'vimwiki/vimwiki',
  init = function()
    -- Configure vimwiki BEFORE the plugin loads
    vim.g.vimwiki_list = {
      {
        path = '~/Documents/vimwiki/',
        syntax = 'markdown',
        ext = '.md',
        path_html = '~/Documents/vimwiki_html/',
        custom_wiki2html = 'vimwiki_markdown',
        template_path = '~/Documents/vimwiki/templates/',
        template_default = 'default',
        template_ext = '.tpl'
      }
    }
    -- Critical settings to prevent filetype conflicts
    vim.g.vimwiki_global_ext = 0 -- Don't treat all .md files as vimwiki
    vim.g.vimwiki_markdown_link_ext = 1
    vim.g.vimwiki_hl_headers = 1
    -- IMPORTANT: This will keep files as markdown filetype for LSP compatibility
    -- We'll handle the filetype in the autocmd below
  end,
  config = function()
    -- Create the vimwiki directory if it doesn't exist
    local vimwiki_path = vim.fn.expand('~/Documents/vimwiki')
    if vim.fn.isdirectory(vimwiki_path) == 0 then
      vim.fn.mkdir(vimwiki_path, 'p')
      print("Created vimwiki directory: " .. vimwiki_path)
    end
    -- Force vimwiki files to keep markdown filetype for LSP compatibility
    vim.api.nvim_create_autocmd({ 'BufRead', 'BufNewFile' }, {
      pattern = vim.fn.expand('~/Documents/vimwiki') .. '/*.md',
      callback = function(ev)
        -- CRITICAL: Force filetype to markdown so marksman attaches
        vim.bo[ev.buf].filetype = 'markdown'
        -- Add vimwiki-specific settings
        vim.opt_local.spell = true
        vim.opt_local.spelllang = 'en_us'
        vim.opt_local.wrap = true
        vim.opt_local.linebreak = true
        -- Vimwiki keymaps (these will work even with markdown filetype)
        local opts = { buffer = ev.buf, silent = true, desc = "Vimwiki" }
        vim.keymap.set('n', '<CR>', '<Plug>VimwikiFollowLink', opts)
        vim.keymap.set('n', '<Backspace>', '<Plug>VimwikiGoBackLink', opts)
        vim.keymap.set('n', '<Tab>', '<Plug>VimwikiNextLink', opts)
        vim.keymap.set('n', '<S-Tab>', '<Plug>VimwikiPrevLink', opts)
      end
    })
    -- Also handle the case when vimwiki tries to set filetype to 'vimwiki'
    vim.api.nvim_create_autocmd('FileType', {
      pattern = 'vimwiki',
      callback = function(ev)
        -- Override back to markdown for LSP compatibility
        vim.bo[ev.buf].filetype = 'markdown'
      end
    })
  end
}
